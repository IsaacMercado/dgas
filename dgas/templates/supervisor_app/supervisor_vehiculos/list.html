{% extends "base.html" %}
{% load static i18n %}
{% load humanize %}
{% block title %}Supervisor - Vehículos{% endblock %}


{% block css %}

    <link rel="stylesheet" href="{% static 'plugins/DataTables/DataTables-1.10.18/css/dataTables.bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/DataTables/Buttons-1.5.6/css/buttons.dataTables.min.css' %}">

{% endblock css %}

{% block content-header %}

    <section class="content-header">
        <h1>
            Vehículos
            <small>listado</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i>listado General</a></li>
        </ol>
    </section>

{% endblock content-header %}

{% block content %}

    <div class="alert alert-success" id="success-alert" style="display: none">
        <button type="button" class="close" data-dismiss="alert">x</button>
        <strong>Mensaje: </strong>
        Regitro procesado.
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Listado general de vehiculos</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">

                    <div class="row" id="vehiculos">
                        <div id="table-combustible" class="container col-md-12">
                            <table id="vehiculos_supervisor"
                                   class="table table-bordered table-striped">
                                <div class="loading-table-data">
                                    <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
                                    <span class="sr-only">Loading...</span>
                                    <p>Loading data...</p>
                                </div>

                            </table>
                        </div>
                    </div>

                </div>

            </div>
            <!-- /.box-body -->
            <div class="overlay" id="loading" style="display: none">
                <i class="fa fa-refresh fa-spin"></i>
            </div>
        </div>
        <!-- /.box -->

        <!-- /.col -->
    </div>
    <!-- /.row -->


{% endblock content %}

{% block js %}

    <script src="{% static 'plugins/DataTables/DataTables-1.10.18/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/DataTables/DataTables-1.10.18/js/dataTables.bootstrap.min.js' %}"></script>
    <script src="{% static 'bower_components/jquery-mask-plugin/dist/jquery.mask.min.js' %}"></script>

    <script src="{% static 'plugins/DataTables/Buttons-1.5.6/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/DataTables/Buttons-1.5.6/js/buttons.flash.min.js' %}"></script>
    <script src="{% static 'bower_components/jszip/dist/jszip.min.js' %}"></script>
    <script src="{% static 'bower_components/pdfmake/build/pdfmake.min.js' %}"></script>
    <script src="{% static 'bower_components/pdfmake/build/vfs_fonts.js' %}"></script>
    <script src="{% static 'plugins/DataTables/Buttons-1.5.6/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/DataTables/Buttons-1.5.6/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'bower_components/moment/min/moment.min.js' %}"></script>
    <script src="{% static 'bower_components/datatables.net-bs/plugins/datetime.js' %}"></script>

    <script type="text/javascript">

        var table;
        var table_cola;
        var combustible_id;
        var control_registrados = 0;

        var URL = "/api/vehiculos_supervisor/";

        var URL_VEH = "/api/vehiculos/";
        var URL_VEH_REB = "/api/vehiculos_rebotados/";

        var URL_ESTACIONES = "/api/estaciones/";

        var URL_COLA = "/api/cola/";
        var URL_COLA_CRUD = "/api/cola-crud/";
        var URL_ULTIMA_COLA = "/api/ultima_cola/";
        var URL_CONTAR_COLA = "/api/cola/contar_cola/";

        var c = '{{ csrf_token }}';
        var ajax_header = {'X-CSRFToken': c};


        $(document).ready(
            function () {


                table = $('#vehiculos_supervisor').DataTable({
                    'serverSide': true,
                    //"scrollY": 200,
                    "scrollX": true,
                    'ajax': '/api/vehiculos_supervisor/?format=datatables',

                    "language": {
                        "url": "{% static 'plugins/DataTables/Spanish.json' %}"
                    },
                    "order": [[0, "desc"]],

                    columnDefs: [
                        {targets: 2, render: $.fn.dataTable.render.moment( 'YYYY-MM-DDTHH:mm:ss.SSSSSSZZ', 'DD/MMM/YYYY HH:MM', 'es' )}
                    ],

                    'columns': [
                         {"title": "Placa", "data": "placa", "responsivePriority": 1,},
                         {"title": "Tipo Vehiculo", "data": "tipo_vehiculo", "responsivePriority": 1,},
                         {"title": "Creado", "data": "created_at", "responsivePriority": 1,},
                         {"title": "Bloqueado", "data": "bloqueado", "responsivePriority": 1,},
                    ],
                    dom: 'lBfrtip',
                    buttons: [
                        'copyHtml5',
                        'print'
                    ],

                    "initComplete": function (settings, json) {
                        $('div.loading-table-data').hide()
                    },

                });

                $('#tabla_combustible tbody').on('click', '#cerrarAbrirCombutible', function () {
                    var data = table.row($(this).parents('tr')).data();
                    var estacion = data['estacion'];

                    if (estacion['operativa']) {
                        var msg = '¿ Desea cerrar esta estación ?';
                        var data_update = {
                            "operativa": false,
                        };
                    } else {
                        var msg = '¿ Desea abrir esta estación ?';
                        var data_update = {
                            "operativa": true,
                        };
                    }

                    var accionar = confirm(msg);

                    if (accionar) {

                        $.ajax(
                            {
                                url: URL_ESTACIONES + estacion['id'] + '/',
                                data: data_update,
                                type: 'patch',
                                dataType: 'json',
                                headers: ajax_header,
                                success: function (data) {
                                    table.ajax.reload();
                                },
                                error: function (request, status, error) {
                                    console.log(request)
                                    //alert(request.responseText);
                                }
                            }
                        );

                    }


                });


                $('#tabla_combustible tbody').on('click', '#verDetalles', function () {

                    var data = table.row($(this).parents('tr')).data();
                    combustible_id = data['id'];

                    $('#cola').show();
                    $('#combustible').hide();

                    $.getJSON(URL_CONTAR_COLA + combustible_id)
                        .done(function (result) {
                            $("#data_estacion").html(result.data.estacion);
                            $("#data_atencion").html(result.data.por_cargar + '/' + result.data.total);
                            $("#data_en_cola").html(result.data.por_cargar);

                        })   // on success - 200
                        .fail(function (result)    // on failure - 404
                            {
                                console.log(result);
                                alert('Fallo')
                            }
                        );


                    table_cola = $('#tabla_colas').DataTable({
                        "processing": true,
                        "serverSide": true,
                        //"scrollY": 200,
                        "scrollX": true,
                        'ajax': '/api/cola/' + data['id'] + '/?format=datatables',
                        "language": {
                            "url": "{% static 'plugins/DataTables/Spanish.json' %}"
                        },

                        "order": [[0, "desc"]],

                        'columns': [

                            {"title": "Id", "data": "id", "responsivePriority": 1,},
                            {"title": "Placa", "data": "vehiculo.placa", "responsivePriority": 1,},
                            {
                                "data": "cargado",
                                "title": "Cargado",
                                "render": function (data, type, row) {
                                    return (data == true) ? '<span class="glyphicon glyphicon-ok"></span>' : '<span class="glyphicon glyphicon-remove"></span > ';
                                }
                            },
                            {
                                "data": null,
                                "defaultContent": "<button>Cargar</button>"
                            }

                        ],

                        "initComplete": function (settings, json) {
                            $('div.loading-table-data').hide()
                        },
                        dom: 'lBfrtip',
                        buttons: [
                            'copyHtml5',
                            //'excelHtml5',
                            //'csvHtml5',
                            //'pdfHtml5',

                            /*
                             {
                                 extend: 'excelHtml5',
                                 customize: function (xlsx) {
                                     //xlsx.xl['styles.xml'] = xmlStyle;
                                     //ecxelCustomize(xlsx);
                                 },
                                 action: function (e, dt, button, config) {
                                     $('.loading').fadeIn();
                                     var that = this;
                                     setTimeout(function () {
                                         $.fn.dataTable.ext.buttons.excelHtml5.action.call(that, e, dt, button, config);
                                         $('.loading').fadeOut();
                                     }, 500);
                                 },
                             },
                             */

                            'print'
                        ]
                    });

                    $('#tabla_colas tbody').on('click', 'button', function () {
                        var data_cola = table_cola.row($(this).parents('tr')).data();
                        var data_update = {
                            "cargado": true,
                        };
                        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
                        $.ajax(
                            {
                                url: URL_COLA + combustible_id + '/' + data_cola['id'] + '/',
                                data: data_update,
                                type: 'patch',
                                dataType: 'json',
                                headers: ajax_header,
                                success: function (data) {
                                    table_cola.ajax.reload();
                                },
                                error: function (request, status, error) {
                                    console.log(request)
                                    //alert(request.responseText);
                                }
                            }
                        );
                    });

                });


            });



    </script>

{% endblock js %}

