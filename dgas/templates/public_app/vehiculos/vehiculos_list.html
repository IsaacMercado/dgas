{% extends "base.html" %}
{% load static i18n %}
{% load static i18n %}
{% load humanize %}
{% load qr_code %}
{% block content-header %}

    <section class="content-header">
        <h1>
            {{ page.title }}
            <small>{{ page.subtitle }}</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Inicio</a></li>
            <li class="active">Inicio</li>
        </ol>
    </section>

{% endblock content-header %}

{% block css %}

    <style type="text/css">
        @media screen {
            #printSection {
                display: none;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #printSection, #printSection * {
                visibility: visible;
            }

            #printSection {
                position: absolute;
                left: 0;
                top: 0;
            }
        }

        @page {
            size: landscape;
        }
    </style>

{% endblock css %}

{% block content %}

    <div class="row">
        <div class="col-md-12">

            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">
                        {% comment %}
                        Estación de servicio: {{ estacion.nombre }}
                        {% endcomment %}

                    </h3>

                    <div class="box-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">

                        </div>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="table-responsive table-striped">

                    <div class="form-horizontal">
                        <div class="box-body">
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-2 control-label">Placa</label>

                                <div class="col-sm-5">
                                    <input type="text" maxlength="7" class="form-control" id="placa"
                                           placeholder="Placa">
                                </div>
                                <div class="col-sm-4">
                                    <button
                                            title="Agregar vehículo" onclick="agregarVehiculo()"
                                            class="btn btn-primary"><i class="fa fa-plus"></i> Agregar
                                        Vehículo
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>


                    <br>
                    <button
                            title="Imprimir todas" onclick="printAllElements()"
                            class="btn btn-primary"><i class="fa fa-print"></i> Imprimir todos los carnets
                    </button>
                    <br><br>

                    <table class="table">
                        <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Cédula</th>
                            <th>Uso de Vehiculo</th>
                            <th>Nro. cilindros</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for vehiculo in vehiculos %}
                            <tr>

                                <td><B>{{ vehiculo.placa }}</B></td>
                                <td><B>{{ vehiculo.cedula }}</B></td>
                                <td><B>{{ vehiculo.tipo_vehiculo }}</B></td>
                                <td><B>{{ vehiculo.cilindros }}</B></td>

                                <td class="text-nowrap">
                                    <div class="btn-group">

                                        <a href="{% url 'public_app:vehiculo_update' vehiculo.pk %}"
                                           class="btn btn-default"><i
                                                class="fa fa-edit"></i> Editar</a>

                                        <a class="btn btn-danger" onclick="deleteVehiculo('{{ vehiculo.placa }}')">
                                            <i class="fa fa-trash-o"></i> Eliminar</a>

                                        {% comment %}
                                        <button type="button" class="btn btn-block btn-default"
                                                onclick="deleteVehiculo('{{ vehiculo.placa }}')">Default
                                        </button>
                                        {% endcomment %}


                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                                data-target="#modal_vehiculo_{{ vehiculo.placa }}">
                                            Carnet del Vehículo
                                        </button>
                                        <div id="modal_vehiculo_{{ vehiculo.placa }}" class="modal fade" tabindex="-1"
                                             role="dialog" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close"><span
                                                                aria-hidden="true">&times;</span></button>
                                                        <h4 class="modal-title" id="gridSystemModalLabel">Carnet del
                                                            Vehículo - {{ vehiculo.placa }}</h4>
                                                    </div>
                                                    <div class="modal-body">

                                                        <div id="printThis_{{ vehiculo.placa }}" class="body-message">

                                                            <div class='box'
                                                                 style="border-style: dashed; border-width: thin; padding: 5px; padding-left: 20px; padding-right: 20px;}">

                                                                <center>

                                                                    <h4>Carnet del Vehículo</h4>

                                                                    {% if user.photo_user == '' %}
                                                                        <img src="{% static 'img/no_photo.png' %}"
                                                                             class="img-circle" height="60"
                                                                             width="60" alt="Sin foto">
                                                                    {% else %}
                                                                        <img src="{{ user.photo_user.thumbnail.60x60 }}"
                                                                             class="img-circle"
                                                                             alt="Foto usuario"/>
                                                                    {% endif %}
                                                                    <img src="{% static '/images/logo_login.png' %}"
                                                                         width="50"><br>


                                                                    <b>Nombre:</b> {{ user.get_full_name|title|default:"Ninguno" }}<br>
                                                                    <b>Cedula:</b> {{ user.cedula|default:"Ninguna" }}<br>

                                                                    <b>Municipio:</b> {{ user.municipio|default:"Ninguna" }}<br>
                                                                    <b>Parroquia:</b> {{ user.parroquia|default:"Ninguna" }}<br>
                                                                    {% qr_from_text vehiculo.placa size=4 image_format="png" error_correction="L" %}<br>
                                                                    {{ vehiculo.placa }}

                                                                </center>

                                                            </div>
                                                        </div>

                                                    </div>
                                                    <div class="modal-footer">
                                                        <button class="btn" data-dismiss="modal" aria-hidden="true">
                                                            Cerrar
                                                        </button>
                                                        <button id="btnPrint" type="button" class="btn btn-default"
                                                                onclick="printElement('printThis_{{ vehiculo.placa }}')">
                                                            Imprimir
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3"> No hay registros de vehículo</td>
                            </tr>

                        {% endfor %}
                        </tbody>
                    </table>
                    {% include "_pagination.html" %}
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="modal-add-vehiculo">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Agregar vehículo</h4>
                </div>
                <div class="modal-body">

                    <br>
                    <label>Placa:</label>
                    <input class="form-control" type="text" placeholder="Default input" id="add_placa" readonly>
                    <br>
                    <label>Cédula:</label>
                    <input class="form-control" type="text" placeholder="Cedula empieza con V o E" id="id_cedula">
                    <br>
                    <br>
                    <!-- select -->
                    <div class="form-group">
                        <label>Tipo de vehiculo</label>
                        <select class="form-control" name="tipo_vehiculo" id="tipo_vehiculo">
                            <option value="Particular">Particular</option>
                            <option value="Transporte Publico">Taxi</option>
                            <option value="Moto">Moto</option>
                        </select>
                    </div>
                    <!-- select -->
                    <div class="form-group">
                        <label>Cilindros</label>
                        <select class="form-control" name="add_cilindros" id="add_cilindros">
                            <option value="1">1</option>
                            <option value="4">2</option>
                            <option value="4">3</option>
                            <option value="4">4</option>
                            <option value="6">6</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <br>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" onclick="addCancelarAdd()">Cancelar</button>
                    <button type="button" onclick="addVehiculo()" class="btn btn-primary">Grabar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    Alerta del sistema
                </div>
                <div class="modal-body">
                    ¿ Seguro de eliminar el vehículo?<br>
                    <b>
                        <div id="placa_delete"></div>
                    </b>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <a class="btn btn-danger btn-ok" onclick="confirmDeleteVehiculo()">Delete</a>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block js %}

    <script src="{% static 'bower_components/jquery-mask-plugin/dist/jquery.mask.min.js' %}"></script>

    <script>

        function printElement(idElem) {
            var domClone = document.getElementById(idElem).cloneNode(true);

            var e = checkElement("printSection");
            deleteChilds();

            e.appendChild(domClone);
            window.print();
        };

        function printAllElements() {

            var e = checkElement("printSection");
            deleteChilds();

            var count = 0;
            var num_fila = 5 - 1;
            var tabla = document.createElement("table");
            var tblBody = document.createElement("tbody");

            var placas = document.querySelectorAll("div[id^=printThis_]");
            var hilera = document.createElement("tr");

            for (var i = 0; i < placas.length; i++) {
                //console.log(count);
                if (count > num_fila) {
                    count = 1;

                    tblBody.appendChild(hilera);
                    var hilera = document.createElement("tr");

                    var celda = document.createElement("td");
                    celda.style = "border: 1px;";
                    celda.valign = "middle";

                    celda.appendChild(placas[i].cloneNode(true));
                    hilera.appendChild(celda);

                } else {
                    count = count + 1;

                    var celda = document.createElement("td");
                    celda.style = "border: 1px;";
                    celda.valign = "middle";

                    celda.appendChild(placas[i].cloneNode(true));
                    hilera.appendChild(celda);
                }
            }
            ;

            tblBody.appendChild(hilera);

            var count = 0;
            tabla.appendChild(tblBody);
            e.appendChild(tabla);
            window.print();
        };

        function deleteChilds() {
            var e = checkElement("printSection");
            var child = e.lastElementChild;
            while (child) {
                e.removeChild(child);
                child = e.lastElementChild;
            }
        };

        function checkElement(div_id) {
            var e = document.getElementById(div_id);
            if (!e) {
                var e = document.createElement("div");
                e.id = "printSection";
                document.body.appendChild(e);
            }
            ;
            return e
        };

        function createRow() {
            var div_row = document.createElement('div');
            div_row.className = 'row';
            return div_row
        };

        function createColumn() {
            var div_column = document.createElement('div');
            div_column.className = 'col-md-4';
            return div_column
        }

    </script>

    <script>

        var URL = "/api/vehiculos_user/";

        var c = '{{ csrf_token }}';
        var ajax_header = {'X-CSRFToken': c};

        $(document).ready(
            function () {

                $("#placa").bind('keyup', function (e) {
                    if (e.which >= 97 && e.which <= 122) {
                        var newKey = e.which - 32;
                        // I have tried setting those
                        e.keyCode = newKey;
                        e.charCode = newKey;
                    }
                    $("#placa").val(($("#placa").val()).toUpperCase());
                });


                var options = {
                    translation: {
                        '0': {pattern: /\d/},
                        '1': {pattern: /[1-9]/},
                        '9': {pattern: /\d/, optional: true},
                        '#': {pattern: /\d/, recursive: true},
                        'C': {pattern: /V|v|E|e|G|g|J|j/, fallback: 'V'}
                    }
                };
                $('#id_cedula').mask('C-19999999', options);

                $('#id_cedula').on('input', function (e) {
                    var cedula = $(this).val();
                    /*
                    if (cedula.length > 9) {
                        var cedula = cedula.substring(2);
                        if (cedula > 80000000) {
                            $(this).val('E-' + cedula);
                        }
                    }
                    */

                });


            });


        function agregarVehiculo() {
            //$("#loading").show();

            var placa_value = $("#placa").val();

            if (placa_value.length < 6) {
                alert('Número de placa invalida')
            } else {
                $.getJSON(URL + placa_value + '/')
                    .done(
                        function (response)    // on failure - 404
                        {

                            if (response.data.usuario == {{ user.id }}) {
                                alert('Vehiculo ya esta registrado en su listado')
                            } else if (response.data.usuario === null) {
                                //vehiculoForm()
                                {% comment %}
                                window.location.replace('{% url 'public_app:vehiculo_update'  %}');
                                {% endcomment %}
                                window.location.replace('/publico/vehiculos/update/' + placa_value);
                            } else {
                                alert('Vehiculo ya esta registrado por otro usuario. \n Si usted es el propietario envia una foto del carnet de circulacion a soporte@combustiblemerida.com indicando el registro indecido de su vehículo')
                            }

                        }
                    )   // on success - 200
                    .fail(function ()    // on failure - 404
                        {
                            window.location.replace('{% url 'public_app:vehiculo_create' %}');
                        }
                    );
            }

        }

        function vehiculoForm() {
            $("#add_placa").val($("#placa").val());
            $('#modal-add-vehiculo').modal('show');
        }

        function addVehiculo() {

            $.ajax(
                {
                    url: URL + $("#placa").val() + '/',
                    data: {
                        "usuario": {{ user.id }},
                        "cedula": $("#id_cedula").val(),
                        "tipo_vehiculo": $("#tipo_vehiculo option:selected").text(),
                        "cilindros": $("#add_cilindros option:selected").text(),
                    },
                    headers: ajax_header,
                    dataType: "json",
                    type: "PATCH",
                    success: function (request) {
                        console.log(request);
                        veh_add_success();
                    },
                    error: function (request, status, error) {
                        alert(request.responseText);
                    }
                }
            ); // ajax()
            $("#loading").hide();
            window.location.replace('{% url 'public_app:vehiculos_list' %}');

        }

        function addCancelarAdd() {
            $("#placa").val('');
            $('#modal-add-vehiculo').modal('hide');


        }

        function veh_add_success() {
            $("#loading").show();
            $("#placa").val("");
            $("#id_cedula").val("");
            $('#modal-add-vehiculo').modal('hide');

        }


        function deleteVehiculo(placa) {

            $("#placa_delete").append(placa);

            $('#confirm-delete').modal('show');

        }

        function confirmDeleteVehiculo() {

            var placa = $("#placa_delete").text();

            $.ajax(
                {
                    url: URL + placa + '/',
                    data: {
                        "usuario": null,
                        "cedula": "V-",
                    },
                    headers: ajax_header,
                    dataType: "json",
                    type: "PATCH",
                    success: function (request) {
                        console.log(request);
                        veh_add_success();
                    },
                    error: function (request, status, error) {
                        alert(request.responseText);
                    }
                }
            ); // ajax()

            $('#confirm-delete').modal('hide');
            location.reload();

        }


    </script>


{% endblock js %}